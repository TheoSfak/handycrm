# 🔐 Σύστημα Ρόλων & Δικαιωμάτων (RBAC)

## 📋 Τι έχει δημιουργηθεί

Το HandyCRM τώρα διαθέτει **πλήρες σύστημα διαχείρισης ρόλων και δικαιωμάτων** που σου επιτρέπει να:

✅ **Δημιουργείς custom ρόλους** για τους χρήστες σου  
✅ **Καθορίζεις ποιες σελίδες** μπορεί να δει κάθε ρόλος  
✅ **Ελέγχεις τι μπορεί να κάνει** κάθε χρήστης (δημιουργία, επεξεργασία, διαγραφή)  
✅ **Προστατεύεις ευαίσθητες λειτουργίες** (οικονομικά, διαγραφές, ρυθμίσεις)  

---

## 🚀 Οδηγίες Εγκατάστασης

### Βήμα 1: Εγκατάσταση Βάσης Δεδομένων

Άνοιξε το **phpMyAdmin** και εκτέλεσε το αρχείο:
```
RBAC_SETUP.sql
```

Αυτό θα δημιουργήσει:
- 📊 Πίνακες: `roles`, `permissions`, `role_permissions`, `permission_audit_log`
- 👥 5 προεπιλεγμένους ρόλους (Admin, Supervisor, Technician, Assistant, Maintenance Technician)
- 🔑 60+ δικαιώματα για όλα τα modules
- ✅ Προεπιλεγμένες αναθέσεις δικαιωμάτων

### Βήμα 2: Επαλήθευση

Μετά την εκτέλεση του SQL, θα δεις στο phpMyAdmin:
```
✓ Roles Created: 5
✓ Permissions Created: 60+
✓ Role Permissions Assigned: 200+
```

---

## 🎯 Πώς να το Χρησιμοποιήσεις

### 1️⃣ Πρόσβαση στη Διαχείριση Ρόλων

Συνδέσου ως **Admin** και πήγαινε στο menu:
```
👤 Ρόλοι & Δικαιώματα
```

### 2️⃣ Δημιουργία Νέου Ρόλου

1. Κλικ στο **"+ Νέος Ρόλος"**
2. Συμπλήρωσε:
   - **Όνομα Συστήματος**: π.χ. `project_manager` (μόνο αγγλικά, χωρίς κενά)
   - **Ετικέτα**: π.χ. "Υπεύθυνος Έργων" (αυτό θα φαίνεται στους χρήστες)
   - **Περιγραφή**: Σύντομη περιγραφή του ρόλου
3. Επίλεξε δικαιώματα:
   - Κάνε κλικ στο checkbox δίπλα στο module για να επιλέξεις όλα
   - Ή επίλεξε συγκεκριμένα δικαιώματα (view, create, edit, delete)
4. Κλικ **"Αποθήκευση"**

### 3️⃣ Επεξεργασία Δικαιωμάτων

1. Από τη λίστα ρόλων, κλικ στο **κουμπί "🔑" (Δικαιώματα)**
2. Θα δεις όλα τα διαθέσιμα δικαιώματα οργανωμένα ανά module
3. Επίλεξε/αποεπίλεξε δικαιώματα
4. Κλικ **"Αποθήκευση Δικαιωμάτων"**

### 4️⃣ Ανάθεση Ρόλου σε Χρήστη

1. Πήγαινε στο menu **"👤 Χρήστες"**
2. Επεξεργασία χρήστη
3. Στο dropdown **"Ρόλος"** επίλεξε τον νέο ρόλο που δημιούργησες
4. Αποθήκευση

---

## 📚 Δομή Δικαιωμάτων

Τα δικαιώματα είναι οργανωμένα σε **modules** και **actions**:

| Module | Actions | Περιγραφή |
|--------|---------|-----------|
| **dashboard** | view | Πρόσβαση στο dashboard |
| **customers** | view, create, edit, delete, export, import | Διαχείριση πελατών |
| **projects** | view, view_all, create, edit, delete, assign, change_status, view_financials, export | Διαχείριση έργων |
| **tasks** | view, create, edit, delete | Εργασίες έργων |
| **materials** | view, create, edit, delete, manage_prices | Κατάλογος υλικών |
| **maintenances** | view, view_all, create, edit, delete, export, send_email | Συντηρήσεις μετασχηματιστών |
| **payments** | view, mark_paid, mark_unpaid, export | Ημερολόγιο πληρωμών |
| **reports** | view, export | Αναφορές συστήματος |
| **users** | view, create, edit, delete, manage_roles | Διαχείριση χρηστών |
| **roles** | view, create, edit, delete, manage_permissions | Διαχείριση ρόλων |
| **settings** | view, edit, smtp, email_templates | Ρυθμίσεις συστήματος |

---

## 🔒 Προστασία Ρόλων

Οι **προεπιλεγμένοι ρόλοι** είναι προστατευμένοι:
- ❌ Δεν μπορούν να διαγραφούν
- ⚠️ Δεν μπορούν να αλλάξουν το όνομα συστήματος
- ✅ Μπορείς να τροποποιήσεις τα δικαιώματά τους

**Custom ρόλοι** που δημιουργείς:
- ✅ Μπορούν να επεξεργαστούν πλήρως
- ✅ Μπορούν να διαγραφούν (αν δεν χρησιμοποιούνται από χρήστες)

---

## 💡 Παραδείγματα Χρήσης

### Παράδειγμα 1: Ρόλος "Γραμματέας"
```
✓ Μπορεί να δει πελάτες
✓ Μπορεί να προσθέσει/επεξεργαστεί πελάτες
✓ Μπορεί να δει έργα
✗ ΔΕΝ μπορεί να επεξεργάσει έργα
✗ ΔΕΝ μπορεί να δει οικονομικά
✗ ΔΕΝ μπορεί να διαγράψει τίποτα
```

**Δικαιώματα:**
- customers: view, create, edit
- projects: view
- dashboard: view

### Παράδειγμα 2: Ρόλος "Team Leader"
```
✓ Μπορεί να δει και να επεξεργαστεί έργα
✓ Μπορεί να αναθέσει τεχνικούς
✓ Μπορεί να αλλάξει κατάσταση έργου
✓ Μπορεί να δει οικονομικά
✗ ΔΕΝ μπορεί να διαχειριστεί χρήστες
✗ ΔΕΝ μπορεί να αλλάξει ρυθμίσεις
```

**Δικαιώματα:**
- projects: view, view_all, create, edit, assign, change_status, view_financials, export
- tasks: view, create, edit, delete
- customers: view, create, edit
- materials: view
- payments: view
- dashboard: view

### Παράδειγμα 3: Ρόλος "Οικονομικός Υπάλληλος"
```
✓ Μπορεί να δει όλα τα έργα
✓ Μπορεί να δει οικονομικά
✓ Μπορεί να σημειώσει πληρωμές
✓ Μπορεί να εξάγει αναφορές
✗ ΔΕΝ μπορεί να επεξεργαστεί έργα
✗ ΔΕΝ μπορεί να διαγράψει τίποτα
```

**Δικαιώματα:**
- projects: view, view_all, view_financials, export
- payments: view, mark_paid, mark_unpaid, export
- reports: view, export
- customers: view
- dashboard: view

---

## 🛠️ Τεχνικές Λεπτομέρειες

### Αρχεία που Δημιουργήθηκαν

#### Backend
```
classes/
├── AuthMiddleware.php      # Middleware για έλεγχο δικαιωμάτων
├── Permission.php          # Model για permissions
└── Role.php               # Model για roles

controllers/
└── RoleController.php     # CRUD για ρόλους
```

#### Views
```
views/roles/
├── index.php              # Λίστα ρόλων
├── create.php             # Δημιουργία ρόλου
├── edit.php              # Επεξεργασία ρόλου
└── permissions.php        # Διαχείριση δικαιωμάτων
```

#### Database
```
tables:
├── roles                  # Πίνακας ρόλων
├── permissions           # Πίνακας δικαιωμάτων
├── role_permissions      # Σύνδεση ρόλων-δικαιωμάτων
└── permission_audit_log  # Log αλλαγών
```

### Χρήση στον Κώδικα

Μπορείς να χρησιμοποιήσεις το σύστημα δικαιωμάτων στον κώδικά σου:

```php
// Έλεγχος αν ο χρήστης έχει δικαίωμα
if (can('projects.edit')) {
    // Εμφάνισε κουμπί επεξεργασίας
}

// Απαίτηση δικαιώματος (throw 403 αν δεν έχει)
requirePermission('projects', 'delete');

// Έλεγχος ρόλου
if (isAdmin()) {
    // Admin-only code
}

if (hasRole('supervisor')) {
    // Supervisor-specific code
}

// Έλεγχος πολλαπλών δικαιωμάτων (OR)
if (canAny(['projects.edit', 'projects.delete'])) {
    // Έχει τουλάχιστον ένα από τα δύο
}

// Έλεγχος πολλαπλών δικαιωμάτων (AND)
if (canAll(['projects.view_financials', 'projects.edit'])) {
    // Έχει και τα δύο
}
```

---

## ❓ FAQ

### Ποια είναι η διαφορά μεταξύ "view" και "view_all";
- **view**: Ο χρήστης βλέπει μόνο τα δικά του (π.χ. τα έργα που του έχουν ανατεθεί)
- **view_all**: Ο χρήστης βλέπει όλα τα records στο σύστημα

### Μπορώ να διαγράψω έναν προεπιλεγμένο ρόλο;
Όχι. Οι ρόλοι `admin`, `supervisor`, `technician`, `assistant`, `maintenance_technician` είναι system roles και δεν μπορούν να διαγραφούν.

### Μπορώ να δημιουργήσω νέα δικαιώματα;
Ναι! Μπορείς να προσθέσεις νέα permissions στη βάση δεδομένων:
```sql
INSERT INTO permissions (module, action, display_name, description) 
VALUES ('custom_module', 'custom_action', 'Το δικό μου δικαίωμα', 'Περιγραφή');
```

### Τι γίνεται αν διαγράψω έναν ρόλο που χρησιμοποιείται;
Το σύστημα δεν επιτρέπει τη διαγραφή ρόλων που έχουν χρήστες. Πρέπει πρώτα να αλλάξεις τον ρόλο των χρηστών.

---

## 📞 Υποστήριξη

Αν έχεις οποιοδήποτε πρόβλημα ή ερώτηση, μπορείς να ελέγξεις:

1. **Logs**: Το σύστημα καταγράφει όλες τις αλλαγές στον πίνακα `permission_audit_log`
2. **Permissions**: Βεβαιώσου ότι ο χρήστης έχει τα σωστά δικαιώματα
3. **Routes**: Έλεγξε ότι τα routes είναι σωστά στο `index.php`

---

## ✅ Checklist Ελέγχου

Πριν ξεκινήσεις να χρησιμοποιείς το σύστημα:

- [x] Εκτέλεσα το `RBAC_SETUP.sql`
- [x] Βλέπω 5 ρόλους στη λίστα
- [x] Βλέπω 60+ permissions
- [x] Μπορώ να δημιουργήσω νέο ρόλο
- [x] Μπορώ να επεξεργαστώ δικαιώματα
- [x] Το menu εμφανίζει "Ρόλοι & Δικαιώματα"
- [x] Μπορώ να αναθέσω ρόλο σε χρήστη

---

🎉 **Συγχαρητήρια! Το σύστημα διαχείρισης ρόλων και δικαιωμάτων είναι εγκατεστημένο και έτοιμο!**
