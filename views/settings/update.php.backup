<?php
require_once 'classes/UpdateChecker.php';

$updateChecker = new UpdateChecker();
$currentVersion = $updateChecker->getCurrentVersion();

// Only check for updates if explicitly requested
$updateAvailable = false;
$updateInfo = null;

if (isset($_POST['check_update']) || isset($_GET['auto_check'])) {
    $updateAvailable = $updateChecker->checkForUpdates();
    $updateInfo = $updateChecker->getUpdateInfo();
}
?>

<style>
/* Beautiful Card Design */
.modern-card {
    border-radius: 12px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}
.modern-card:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    transform: translateY(-4px);
}

/* Gradient Backgrounds */
.gradient-purple {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.gradient-green {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}
.gradient-blue {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}
.gradient-orange {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

/* Version Badge with Animation */
.version-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 32px;
    border-radius: 10px;
    font-size: 1.8rem;
    font-weight: 700;
    display: inline-block;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    animation: pulse-soft 3s ease-in-out infinite;
}
.update-badge {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    padding: 16px 32px;
    border-radius: 10px;
    font-size: 1.8rem;
    font-weight: 700;
    display: inline-block;
    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
    animation: pulse-glow 2s ease-in-out infinite;
}

@keyframes pulse-soft {
    0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
    50% { transform: scale(1.02); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
}
@keyframes pulse-glow {
    0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4); }
    50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(56, 239, 125, 0.6); }
}

/* Status Indicators */
.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    box-shadow: 0 0 8px currentColor;
}
.status-active { 
    background: #28a745; 
    animation: glow-green 2s ease-in-out infinite;
}
.status-update { 
    background: #ffc107; 
    animation: pulse-yellow 1.5s ease-in-out infinite;
}
@keyframes glow-green {
    0%, 100% { box-shadow: 0 0 8px rgba(40, 167, 69, 0.6); }
    50% { box-shadow: 0 0 16px rgba(40, 167, 69, 1); }
}
@keyframes pulse-yellow {
    0%, 100% { transform: scale(1); box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); }
    50% { transform: scale(1.2); box-shadow: 0 0 16px rgba(255, 193, 7, 1); }
}

/* Info Rows */
.info-row {
    padding: 12px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    transition: background 0.2s ease;
}
.info-row:last-child { border-bottom: none; }
.info-row:hover {
    background: rgba(0,0,0,0.02);
    padding-left: 8px;
}

/* Modern Buttons */
.btn-modern {
    padding: 10px 24px;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}
.btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.btn-gradient-purple {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.btn-gradient-purple:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    color: white;
}
.btn-gradient-green {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}
.btn-gradient-green:hover {
    background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
    color: white;
}

/* Card Headers */
.card-header-modern {
    padding: 12px 20px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.85rem;
    border-bottom: 3px solid rgba(0,0,0,0.1);
}

/* Icons with Animation */
.icon-float {
    animation: float 3s ease-in-out infinite;
}
@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

/* Glass Effect */
.glass-effect {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

/* Shimmer Effect for Loading */
.shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
}
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Stat Box */
.stat-box {
    text-align: center;
    padding: 16px;
    border-radius: 8px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    transition: all 0.3s ease;
}
.stat-box:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
    transform: scale(1.05);
}

/* Alert Modern */
.alert-modern {
    border-radius: 10px;
    border: none;
    padding: 16px 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
</style>

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <div class="mb-4">
                <i class="fas fa-sync-alt fa-5x text-primary icon-float"></i>
            </div>
            <h1 class="display-4 mb-3 fw-bold">Ενημερώσεις Συστήματος</h1>
            <p class="lead text-muted mb-4" style="font-size: 1.3rem;">Διαχείριση και έλεγχος εκδόσεων HandyCRM</p>
            <a href="https://github.com/<?= $updateChecker->githubRepo ?>" target="_blank" class="btn btn-outline-dark btn-modern btn-lg">
                <i class="fab fa-github me-2"></i>View on GitHub
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            
            <!-- Current Version Card -->
            <div class="card modern-card mb-5">
                <div class="card-body p-0">
                    <div class="gradient-purple p-5 text-white text-center">
                        <div class="mb-4">
                            <i class="fas fa-box-open fa-5x opacity-75 icon-float"></i>
                        </div>
                        <h4 class="text-uppercase opacity-75 mb-4" style="letter-spacing: 4px; font-size: 1.2rem;">Τρέχουσα Έκδοση</h4>
                        <div class="mb-5" style="font-size: 3rem; font-weight: 800; text-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                            v<?= $currentVersion ?>
                        </div>
                        
                        <div class="row g-4 justify-content-center mt-4">
                            <div class="col-md-4">
                                <div class="stat-box bg-white bg-opacity-10 text-white p-4">
                                    <div class="mb-3">
                                        <span class="status-dot status-active" style="width: 16px; height: 16px;"></span>
                                    </div>
                                    <div class="text-uppercase opacity-75 mb-2" style="font-size: 0.9rem; letter-spacing: 2px;">Status</div>
                                    <strong class="d-block" style="font-size: 1.4rem;">ACTIVE</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box bg-white bg-opacity-10 text-white p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-code fa-2x"></i>
                                    </div>
                                    <div class="text-uppercase opacity-75 mb-2" style="font-size: 0.9rem; letter-spacing: 2px;">PHP</div>
                                    <strong class="d-block" style="font-size: 1.4rem;"><?= phpversion() ?></strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box bg-white bg-opacity-10 text-white p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-clock fa-2x"></i>
                                    </div>
                                    <div class="text-uppercase opacity-75 mb-2" style="font-size: 0.9rem; letter-spacing: 2px;">Έλεγχος</div>
                                    <strong class="d-block" style="font-size: 1.2rem;"><?= isset($_SESSION['last_update_check']) ? date('d/m H:i', $_SESSION['last_update_check']) : 'Ποτέ' ?></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                    <!-- Check for Updates Action -->
                    <?php if (!isset($_POST['check_update']) && !isset($_GET['auto_check'])): ?>
                        <div class="card modern-card glass-effect mb-5">
                            <div class="card-body p-5 text-center">
                                <div class="mb-5">
                                    <div class="d-inline-block position-relative">
                                        <i class="fas fa-search fa-6x text-primary icon-float"></i>
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 1.2rem; padding: 0.5rem 0.8rem;">
                                            !
                                        </span>
                                    </div>
                                </div>
                                <h2 class="mb-4 fw-bold" style="font-size: 2.5rem;">Έλεγχος για Ενημερώσεις</h2>
                                <p class="text-muted mb-5" style="font-size: 1.3rem;">
                                    Ελέγξτε αν υπάρχουν νέες εκδόσεις διαθέσιμες στο GitHub repository
                                </p>
                                <form method="POST" class="d-inline-block">
                                    <button type="submit" name="check_update" class="btn btn-modern btn-gradient-purple btn-lg px-5 py-4" style="font-size: 1.3rem;">
                                        <i class="fas fa-sync-alt me-3"></i>
                                        Έλεγχος Τώρα
                                    </button>
                                </form>
                                <div class="mt-5">
                                    <p class="text-muted mb-0" style="font-size: 1.1rem;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Θα ελεγχθεί το GitHub για νεότερες εκδόσεις
                                    </p>
                                </div>
                            </div>
                        </div>
                    <?php endif; ?>

                    <?php if ($updateAvailable && $updateInfo): ?>
                        <!-- Update Available -->
                        <div class="card modern-card border-0 mb-5">
                            <div class="gradient-green p-5 text-white text-center">
                                <div class="mb-5">
                                    <i class="fas fa-rocket fa-6x icon-float opacity-75"></i>
                                </div>
                                <h4 class="text-uppercase opacity-75 mb-4" style="letter-spacing: 4px; font-size: 1.2rem;">Νέα Έκδοση</h4>
                                <div class="mb-5" style="font-size: 3.5rem; font-weight: 800; text-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                    v<?= htmlspecialchars($updateInfo['version']) ?>
                                </div>
                                <div class="mb-5">
                                    <span class="status-dot status-update" style="width: 20px; height: 20px;"></span>
                                    <span class="text-uppercase fw-bold" style="font-size: 1.4rem; letter-spacing: 2px;">Διαθέσιμη</span>
                                </div>
                                
                                <h2 class="mb-4 fw-bold" style="font-size: 2.5rem;">
                                    <i class="fas fa-gift me-3"></i>
                                    Ενημέρωση Διαθέσιμη!
                                </h2>
                                <p class="mb-5 opacity-90" style="font-size: 1.4rem;">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Κυκλοφόρησε: <strong><?= date('d/m/Y H:i', strtotime($updateInfo['published_at'])) ?></strong>
                                </p>
                                
                                <div class="d-flex gap-4 justify-content-center flex-wrap">
                                    <a href="<?= htmlspecialchars($updateInfo['download_url']) ?>" 
                                       class="btn btn-light btn-modern btn-lg px-5 py-4" style="font-size: 1.3rem;">
                                        <i class="fas fa-cloud-download-alt me-3"></i>
                                        Κατέβασμα Τώρα
                                    </a>
                                    <a href="<?= htmlspecialchars($updateInfo['release_url']) ?>" 
                                       target="_blank" 
                                       class="btn btn-outline-light btn-modern btn-lg px-5 py-4" style="font-size: 1.3rem;">
                                        <i class="fab fa-github me-3"></i>
                                        GitHub
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Release Notes -->
                        <div class="card modern-card mb-4">
                            <div class="card-header card-header-modern gradient-blue text-white text-center">
                                <i class="fas fa-list-ul me-2"></i>
                                Τι Νέο Υπάρχει
                            </div>
                            <div class="card-body p-4 text-center" style="max-height: 300px; overflow-y: auto;">
                                <div class="release-notes">
                                    <?= nl2br(htmlspecialchars($updateInfo['release_notes'] ?? 'Δείτε τις λεπτομέρειες στο GitHub.')) ?>
                                </div>
                            </div>
                        </div>

                        <!-- Warning Alert -->
                        <div class="alert alert-modern alert-warning mb-4">
                            <div class="text-center">
                                <div class="mb-3">
                                    <i class="fas fa-exclamation-triangle fa-3x"></i>
                                </div>
                                <h5 class="fw-bold mb-3">Σημαντικές Οδηγίες Ενημέρωσης</h5>
                                <p class="mb-3">Πριν ξεκινήσετε την ενημέρωση:</p>
                                <div class="row g-3 text-start">
                                    <div class="col-md-6">
                                        <div class="p-3 bg-white rounded">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            Κάντε πλήρες backup της βάσης δεδομένων
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="p-3 bg-white rounded">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            Κάντε αντίγραφο ασφαλείας όλων των αρχείων
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="p-3 bg-white rounded">
                                            <i class="fas fa-times-circle text-danger me-2"></i>
                                            <strong>ΜΗΝ</strong> αντικαταστήσετε το <code>config/config.php</code>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="p-3 bg-white rounded">
                                            <i class="fas fa-times-circle text-danger me-2"></i>
                                            <strong>ΜΗΝ</strong> αντικαταστήσετε τον φάκελο <code>uploads/</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recheck Button -->
                        <div class="text-center">
                            <form method="POST" class="d-inline-block">
                                <button type="submit" name="check_update" class="btn btn-modern btn-outline-primary btn-lg px-5">
                                    <i class="fas fa-redo me-2"></i>
                                    Έλεγχος Ξανά
                                </button>
                            </form>
                        </div>

                    <?php elseif (isset($_POST['check_update']) || isset($_GET['auto_check'])): ?>
                        <!-- No Updates Available -->
                        <div class="card modern-card glass-effect border-success mb-5">
                            <div class="card-body p-5 text-center">
                                <div class="mb-5">
                                    <i class="fas fa-check-circle text-success fa-6x icon-float"></i>
                                </div>
                                <h1 class="mb-4 fw-bold text-success" style="font-size: 3rem;">Είστε Ενημερωμένοι!</h1>
                                <p class="text-muted mb-5" style="font-size: 1.4rem;">
                                    Χρησιμοποιείτε την πιο πρόσφατη έκδοση του HandyCRM
                                </p>
                                <div class="alert alert-modern alert-success d-inline-block mb-5" style="font-size: 1.2rem; padding: 1.5rem 2rem;">
                                    <i class="fas fa-thumbs-up me-2"></i>
                                    Η εφαρμογή σας είναι up-to-date με τις τελευταίες βελτιώσεις
                                </div>
                                <div class="mt-4">
                                    <form method="POST" class="d-inline-block">
                                        <button type="submit" name="check_update" class="btn btn-modern btn-gradient-green btn-lg px-5 py-4" style="font-size: 1.3rem;">
                                            <i class="fas fa-redo me-3"></i>
                                            Έλεγχος Ξανά
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    <?php endif; ?>

                    <!-- Update Instructions -->
                    <div class="card modern-card mb-4">
                        <div class="card-header card-header-modern gradient-orange text-white text-center">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Οδηγίες Ενημέρωσης
                        </div>
                        <div class="card-body p-5">
                            <div class="row g-4 justify-content-center">
                                <div class="col-md-6 col-lg-5">
                                    <div class="text-center p-4 rounded" style="background: rgba(102, 126, 234, 0.08);">
                                        <div class="mb-3">
                                            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                                <strong>1</strong>
                                            </div>
                                        </div>
                                        <h5 class="fw-bold mb-3">Backup Βάσης</h5>
                                        <p class="mb-2 small">Εξαγωγή της βάσης δεδομένων:</p>
                                        <div class="bg-white p-2 rounded">
                                            <code class="small">mysqldump -u user -p db > backup.sql</code>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-5">
                                    <div class="text-center p-4 rounded" style="background: rgba(17, 153, 142, 0.08);">
                                        <div class="mb-3">
                                            <div class="rounded-circle bg-success text-white d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                                <strong>2</strong>
                                            </div>
                                        </div>
                                        <h5 class="fw-bold mb-3">Κατέβασμα</h5>
                                        <p class="mb-3 small">Λήψη από GitHub:</p>
                                        <a href="https://github.com/<?= $updateChecker->githubRepo ?>/releases" target="_blank" class="btn btn-success btn-modern">
                                            <i class="fab fa-github me-2"></i>Releases
                                        </a>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-5">
                                    <div class="text-center p-4 rounded" style="background: rgba(255, 193, 7, 0.08);">
                                        <div class="mb-3">
                                            <div class="rounded-circle bg-warning text-dark d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                                <strong>3</strong>
                                            </div>
                                        </div>
                                        <h5 class="fw-bold mb-3">Αντικατάσταση</h5>
                                        <p class="mb-2 small">Ανέβασμα μέσω FTP</p>
                                        <p class="mb-0 small text-danger">
                                            <i class="fas fa-exclamation-circle me-1"></i>
                                            Εξαιρέστε: <code>config/</code> & <code>uploads/</code>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-5">
                                    <div class="text-center p-4 rounded" style="background: rgba(23, 162, 184, 0.08);">
                                        <div class="mb-3">
                                            <div class="rounded-circle bg-info text-white d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                                <strong>4</strong>
                                            </div>
                                        </div>
                                        <h5 class="fw-bold mb-3">Έλεγχος</h5>
                                        <p class="mb-0 small">Σύνδεση και επαλήθευση λειτουργίας όλων των modules</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Additional Info -->
                    <div class="row g-4 mt-3">
                        <!-- System Information -->
                        <div class="col-md-6">
                            <div class="card modern-card">
                                <div class="card-header card-header-modern gradient-purple text-white text-center">
                                    <i class="fas fa-server me-2"></i>
                                    Πληροφορίες Συστήματος
                                </div>
                                <div class="card-body p-4 text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-code text-primary fa-2x mb-2"></i>
                                        <p class="mb-1 text-muted small">PHP Version</p>
                                        <h5 class="mb-0 fw-bold"><?= phpversion() ?></h5>
                                    </div>
                                    <div class="mb-3">
                                        <i class="fas fa-database text-success fa-2x mb-2"></i>
                                        <p class="mb-1 text-muted small">Database</p>
                                        <h5 class="mb-0 fw-bold">MySQL</h5>
                                    </div>
                                    <div>
                                        <i class="fas fa-server text-warning fa-2x mb-2"></i>
                                        <p class="mb-1 text-muted small">Web Server</p>
                                        <h5 class="mb-0 fw-bold"><?= explode('/', $_SERVER['SERVER_SOFTWARE'])[0] ?? 'Apache' ?></h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Version History -->
                        <div class="col-md-6">
                            <div class="card modern-card">
                                <div class="card-header card-header-modern gradient-blue text-white text-center">
                                    <i class="fas fa-history me-2"></i>
                                    Ιστορικό Εκδόσεων
                                </div>
                                <div class="card-body p-4">
                                    <div class="text-center mb-4 pb-3 border-bottom">
                                        <div class="mb-2">
                                            <div class="rounded-circle bg-success text-white d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="fas fa-check"></i>
                                            </div>
                                        </div>
                                        <h6 class="mb-1 fw-bold">v1.0.1</h6>
                                        <small class="text-muted d-block mb-2">
                                            <i class="fas fa-calendar me-1"></i>Ιανουάριος 2025
                                        </small>
                                        <p class="mb-0 small">Auto-update system, GitHub integration, Modern UI</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="mb-2">
                                            <div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="fas fa-star"></i>
                                            </div>
                                        </div>
                                        <h6 class="mb-1 fw-bold">v1.0.0</h6>
                                        <small class="text-muted d-block mb-2">
                                            <i class="fas fa-calendar me-1"></i>09/01/2025
                                        </small>
                                        <p class="mb-0 small">Αρχική έκδοση με πλήρη CRM features</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Support Card -->
                    <div class="card modern-card glass-effect mt-4">
                        <div class="card-body p-5 text-center">
                            <div class="mb-4">
                                <i class="fas fa-headset fa-4x text-primary icon-float"></i>
                            </div>
                            <h4 class="fw-bold mb-3">Χρειάζεστε Βοήθεια;</h4>
                            <p class="text-muted mb-4">
                                Για υποστήριξη ή ερωτήσεις επικοινωνήστε μαζί μας
                            </p>
                            <a href="mailto:theodore.sfakianakis@gmail.com" class="btn btn-modern btn-gradient-purple btn-lg px-5">
                                <i class="fas fa-envelope me-2"></i>
                                Επικοινωνία
                            </a>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>